---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-config
  namespace: production
  labels:
    app: backend
    tier: api
data:
  NODE_ENV: "production"
  PORT: "3000"
  LOG_LEVEL: "info"
  CORS_ORIGIN: "http://frontend:80"
  RATE_LIMIT_WINDOW_MS: "900000"
  RATE_LIMIT_MAX: "100"
---
apiVersion: v1
kind: Secret
metadata:
  name: backend-secrets
  namespace: production
  labels:
    app: backend
    tier: api
type: Opaque
data:
  JWT_SECRET: "Y2hhbmdlLXRoaXMtdG8tYS1zZWN1cmUtcmFuZG9tLXN0cmluZy1pbi1wcm9kdWN0aW9u"
  API_KEY: "Y2hhbmdlLXRoaXMtYXBpLWtleS1pbi1wcm9kdWN0aW9u"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: production
  labels:
    app: backend
    tier: api
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: backend
      tier: api
  template:
    metadata:
      labels:
        app: backend
        tier: api
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: backend-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - backend
                topologyKey: kubernetes.io/hostname
      containers:
        - name: backend
          image: node:20-alpine
          command: ["/bin/sh", "-c"]
          args:
            - |
              mkdir -p /app
              cat > /app/package.json << 'EOF'
              {
                "name": "production-api",
                "version": "1.0.0",
                "main": "server.js",
                "dependencies": {
                  "express": "^4.18.2",
                  "pg": "^8.11.3",
                  "redis": "^4.6.10",
                  "cors": "^2.8.5",
                  "helmet": "^7.1.0",
                  "compression": "^1.7.4",
                  "express-rate-limit": "^7.1.5",
                  "prom-client": "^15.1.0",
                  "winston": "^3.11.0",
                  "jsonwebtoken": "^9.0.2",
                  "bcrypt": "^5.1.1",
                  "uuid": "^9.0.1"
                }
              }
              EOF

              cat > /app/server.js << 'EOF'
              // NodeJS server content (unchanged)
              EOF

              cd /app && npm install && node server.js
          ports:
            - containerPort: 3000
              name: http
          env:
            - name: NODE_ENV
              valueFrom:
                configMapKeyRef:
                  name: backend-config
                  key: NODE_ENV
            - name: PORT
              valueFrom:
                configMapKeyRef:
                  name: backend-config
                  key: PORT
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: backend-config
                  key: LOG_LEVEL
            - name: CORS_ORIGIN
              valueFrom:
                configMapKeyRef:
                  name: backend-co
